# vim:ft=ansible:
- name: Deploy a web application
  hosts: db_and_web_servers
  tasks:
        - name: Install all Dependancies
          apt: 
                name: ['python','python-setuptools','python-dev','build-essential','python-pip','python-mysqldb'] 
                state: present 
                update-cache: yes

        - name: Install Mysql
          apt: name={{ item }} state=installed
          with_items:
                - mysql-server
                - mysql-client

        - name: Start MySQL Service
          service:
                name: mysql
                state: started
                enabled: yes

        - name: Create Application Database
          mysql_db: name=employee_db state=present
        
        - name: Create Application User
          mysql_user:
                name: db_user
                password: Passw0rd
                priv: '*.*:ALL'
                state: present

        - name: Install Python Flask dependancy
          pip: name={{ item }} state=present
          with_items:
                - flask
                - flask-mysql

        - name: Copy source code
          copy: src=app.py dest=/opt/app.py

        - name: Start WebServer
          shell: FLASK_APP=/opt/app.py nohup flask run --host=0.0.0.0 &
